# DevRule — PureSuck 主题重构规则

## 1. 范围与基线
- 主题必须坚持 SSR 优先（核心可读内容由 Typecho/PHP 模板直接输出）。
- JavaScript 仅用于增强体验，不得承担主内容渲染职责。
- 发布形态必须保持“解压即用”，不能强制依赖 Node 构建流程。

## 2. 运行时架构
- 全局命名空间限制为 `window.PS`，且仅暴露稳定 API。
- 前端增强模块必须遵循生命周期契约：
  - `init(root, context)`
  - `destroy(root, context)`
- Swup 生命周期必须统一映射：
  - 替换前/跳转前：集中 `destroy`
  - 替换后/`page:view`：集中 `init`
- 单个模块初始化或销毁失败不得影响全站可用性。

## 3. 降级与回滚
- Swup 必须可通过主题配置关闭，关闭后仍可正常导航。
- View Transitions 属于增强能力：
  - 不支持或关闭时，必须自动回退到普通卡片转场。
- `prefers-reduced-motion: reduce` 下应关闭位移/缩放类动画。
- 任何“预隐藏”状态必须有兜底清理，避免内容永久不可见。

## 4. 页面结构与选择器规范
- 所有模板必须存在 `#swup`，且只包裹可替换的主内容区域。
- `header/sidebar/footer` 保持在 `#swup` 外，避免重复绑定与闪烁。
- 页面类型唯一真相源：
  - `#swup[data-ps-page-type="list|post|page"]`
- 共享元素匹配唯一真相源：
  - 服务端输出 `data-ps-post-key`（稳定标识，默认 `cid`）。

## 5. CSS 与动效约束
- 动效默认只允许 `transform` 与 `opacity`。
- `top/left/width/height/margin` 等布局动画默认禁用，需明确理由才可使用。
- `will-change` 必须短时使用，不允许常驻大面积开启。
- 动效时长与缓动需统一来自集中变量，不得分散硬编码。

## 6. PHP 渲染管线
- `renderPostContent($content)` 保持为文章内容唯一入口。
- 渲染步骤必须明确、可追踪、顺序稳定。
- 管线应满足幂等，或具备“已处理标记”避免二次包裹。
- 缓存键至少包含：
  - 主题版本
  - 内容哈希
  - 影响输出的配置指纹

## 7. 状态与数据纪律
- 减少 `$GLOBALS` 依赖；若为兼容保留，需有结构化镜像上下文。
- 队列、定时器、observer 必须可回收，禁止无界增长。
- 禁止向 `window` 挂载大范围可变业务状态。

## 8. 兼容策略
- 现有短代码与主题设置默认保持兼容。
- 新增配置项默认值应尽量对齐既有行为，避免升级后意外变更。
- 行为变更必须保留回退路径，并记录到规则文档或变更记录。

## 9. 每次改动必做校验
- 无 JS：页面阅读、分页、导航可用。
- Swup 关闭/失败：原生跳转可用。
- Reduced Motion：无强位移/缩放动画。
- 多次导航后：无重复事件绑定。
- 中断转场后：无残留隐藏状态。
- 关键模板通过 PHP 语法检查。

## 10. 当前重构阶段
- Phase A（当前）：运行时核心、Swup 生命周期统一、配置开关、渲染缓存加固。
- Phase B：模板局部抽离与重复结构收敛。
- Phase C：性能专项（长任务、重排热点、图片/LCP/CLS）。

## 11. 动画实现规范（A/B 双形态）
- 必须采用“转场决策器”：
  - 优先判定形态 A（共享元素 VT）
  - 无法满足条件则强制回退形态 B（普通卡片转场）
- 形态 A 触发条件：
  - 浏览器支持 `document.startViewTransition`
  - `enableViewTransition=1`
  - 非 `prefers-reduced-motion`
  - 存在可匹配的 `data-ps-post-key` 共享元素
- 形态 A 执行约束：
  - 共享元素主体只做 morph，不叠加额外缩放动画
  - 非共享元素仅允许轻量淡出/淡入
  - 任意共享标记必须在失败或回退时清理
- 形态 B 执行约束：
  - 仅使用 `transform/opacity`
  - 列表允许轻量 stagger，但延迟受控
  - 支持快速连续导航中断，不得残留隐藏态
- 转场状态必须可中断：
  - 统一维护 timer/状态 class
  - 新导航开始时先清理旧状态，再进入下一次转场

## 12. 文档同步机制（强制）
- 所有“按 DevPlan 推进的改造”必须同时更新三份文档：
  - `DevPlan.md`：阶段目标与约束（计划层）
  - `DevRule.md`：实现规则与不可违反项（规则层）
  - `RefactorRecord.md`：本次过程与结果（记录层）
- 每次提交前，`RefactorRecord.md` 至少要写明：
  - 改了哪些文件
  - 对照 DevPlan 完成了什么
  - 风险/回滚点与已做验证

## 13. 列表渐入与 VT 分层规范（新增）
- 适用范围：`index.php` / `archive.php` 的 `.post.post--index` 卡片，以及列表辅助区块（标题、分页、尾部信息）。
- 列表进入动效主风格为 `fadeInUp`（淡入 + 上移），并保持“可感知但不破版”的视觉强度。
- 触发策略：在大部分允许场景执行列表渐入（包含首屏与常规列表进入），不得退化为“只有首屏有动效”。
- 首屏不依赖 Swup：即使 Swup 关闭或初始化失败，首屏列表进入观感必须保持一致。
- VT 分层（硬规则）：
  - `post -> list` 且命中 VT（形态 A）时，VT 期间仅允许共享元素 morph。
  - VT 期间必须隐藏非共享卡片与列表辅助区块，禁止提前入场。
  - VT 结束后再触发非共享卡片与辅助区块的 `fadeInUp` 进入。
- 无障碍：`prefers-reduced-motion: reduce` 时禁用位移/缩放，避免强制运动。
- 安全清理：VT 分层相关 class/timer 必须可清理，避免残留导致内容长期不可见。

## 14. 页面模板动画一致性规范（新增）
- 所有“页面类模板”统一归入 `page` 动画语义；`archives.php` 不允许作为独立动画类型处理。
- `page` 动画选择器必须基于统一结构标记（`data-ps-page-shell`）命中，不得依赖模板文件名。
- `header.php` 的 pageType 判定中，自定义页面模板应通过 `is('page')` 归类，避免写分支特判造成语义漂移。
- 进入、退出、预载三阶段必须命中同一 `page shell` 目标，确保 `page.php` 与自定义页面模板视觉一致。
- 为消除长页面观感偏差，`page shell` 必须使用统一 `transform-origin`，并可使用 page 专属 scale 参数；禁止模板级单独调参。

## 15. 右栏三栏布局规范（新增）
- 右栏必须作为独立语义列存在于布局容器中，禁止通过 `display:inline`、大幅 `padding-right` 等方式“视觉伪三栏”。
- `#swup` 仅包裹正文列；右栏不得位于 `#swup` 内，避免 Swup `content:replace` 误替换侧栏。
- 所有模板不得手动重复插入侧栏；侧栏输出应在统一骨架层集中处理，避免结构漂移。
- 桌面端右栏定位优先 `position: sticky`（栏内），避免全局 `position: fixed` 破坏布局流。
- TOC 相关脚本不得动态改写右栏定位（例如运行时强制改成 `absolute`），应只控制 TOC 状态 class。
