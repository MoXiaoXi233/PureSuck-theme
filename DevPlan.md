# DevPlan — PureSuck Typecho 主题重构（务实版）

> 目标：在不改变 Typecho SSR（服务端渲染）本质的前提下，把主题的**结构、可维护性与性能**拉到一个可长期迭代的状态；同时保留“干净、淡雅、动效自然”的体验。

本文件是“重构路线图”，不是“架构宣言”。所有“必须”都应有清晰的收益与落地成本评估。

---

## 0. 现实检查（先把不切实际的部分收敛）

### 0.1 Typecho 主题的硬约束
- **发布形态优先**：主题应做到“解压即用”，不能强依赖 Node 构建流程；如需构建，应提供**可直接使用的构建产物**（并让无构建用户不受影响）。
- **SSR 是主路径**：页面可用性来自 PHP 模板输出的 HTML；JS 永远只做增强（Swup/VT/动效/交互）。
- **兼容性是策略，不是口号**：例如 View Transitions、requestIdleCallback 都应视为增强能力，必须有降级路径。

### 0.2 需要降级的“过度设计”点（本次重构默认不做/不强推）
- 把主题改造成“前端工程化项目”（Vite/TS/manifest/dist/src 全套）——**除非你明确要走构建路线**，否则会显著增加维护与使用成本。
- “Islands” 作为强制架构（每个交互都 data-island + mount/unmount + hydrate 策略）——在 Typecho 主题场景容易变成“规范负担”。更务实的做法是：**模块注册 + Swup 生命周期钩子**。
- 过于激进的体积 KPI（如 runtime ≤ 8KB、首屏 JS ≤ 10KB）——与实际功能（Swup、动效、组件）不匹配。可以保留“目标”，但不要把它写成不可违背的硬指标。

---

## 1. 重构目标与非目标

### 1.1 重构目标（会做）
- **结构清晰**：模板/功能文件分工明确、命名一致、重复代码减少。
- **可回归**：Swup/动效/懒加载等增强能力可一键关闭或自动降级，页面仍可用。
- **性能可控**：能定位慢在哪（长任务/重排/图片/缓存命中率），并能持续改善。
- **对外稳定**：保持现有用户设置项与短代码（shortcodes）大体兼容，不轻易破坏内容。

### 1.2 非目标（默认不做）
- 不做 SPA 化改造（Typecho 仍是多页应用；Swup 只是“可失败的增强”）。
- 不追求“极限极简 JS/CSS 体积”，优先追求“更少的无谓工作、更少的卡顿”。
- 不引入大型前端框架作为基础（React/Vue 等）。

---

## 2. 可验证的完成标准（用“可落地”的指标替代理想 KPI）

> 指标用于帮助决策和防止回退；不做“一票否决”的死规矩。

- **无 JS 可用**：文章/页面可阅读，可分页/可导航；评论至少能显示，提交可走 Typecho 默认流程（即使体验较弱）。
- **动效可控**：`prefers-reduced-motion: reduce` 时不应强行动画；动效优先 `transform/opacity`，尽量避免触发布局抖动。
- **可观测**：能通过 Chrome Performance 或简单埋点定位：Swup 切换阶段耗时、主要长任务来源、图片加载/懒加载命中情况。
- **缓存收益明确**：文章内容渲染（TOC/短代码/表情等）应有可解释的缓存命中与失效策略。

---

## 3. 分阶段里程碑（先把收益最大的做完）

### Phase 0：盘点与“可安全回滚”
- 列出当前增强能力清单：Swup、VT、懒加载、medium-zoom、OwO、MoxDesign、短代码组件、TOC、缓存等。
- 为增强能力加“总开关/降级路径”（至少做到：Swup 出错自动退回普通跳转；某模块初始化失败不影响主内容）。

### Phase 1：模板结构与 HTML 规范（不求完美，但求一致）
- 抽取 `partials/`（或 `components/`）逐步搬迁：head、header、footer、post-meta、toc、pagination 等。
- 保持 `#swup` 容器在所有模板一致存在；避免把 header/footer 放入 `#swup`（减少重复绑定与闪烁）。
- 统一可复用的 class/data 属性命名（减少“同一语义多套类名”的情况）。

### Phase 2：JS 组织方式（替代“Islands 强规范”）
- 建立一个“模块注册表”概念：每个模块暴露 `init(root)` / `destroy(root)`（或类似）即可。
- Swup 生命周期中只做两件事：
  - 进入前：集中 `destroy`（解绑事件/observer/RAF/timer）。
  - 进入后：集中 `init`（只在需要的页面类型或 DOM 存在时初始化）。
- 把“页面类型差异”（list/post/page）收敛成少量条件分支，避免在 JS 里散落大量模板细节。

### Phase 3：性能与体验打磨（基于真实瓶颈）
- 对 `PureSuck_Swup.js` 做“可维护性重构”：分文件/分模块（即便仍然发布为一个文件）。
- 清理不必要的同步工作：首屏关键路径尽量少做 DOM 查询、少做强制同步布局（layout thrash）。
- 图片/字体策略：优先修复“首屏大图/头像/字体”导致的 LCP/CLS 问题，再做更细的微优化。

---

## 4. CSS 约定（保留原则，但降低形式负担）

- 主题配色用 CSS 变量集中管理（现有的动态 CSS 也可继续，但要**把变量当作单一真相源**）。
- 动画默认只做 `transform/opacity`；涉及 `height/width/top/left/margin` 必须说明理由并控制范围。
- 必须兼容 `prefers-reduced-motion`：减少动画、缩短时长或直接关闭关键转场。
- 任何“为了动画而加 will-change”都必须审慎使用，避免常驻占用资源。

---

## 5. JS 约定（以稳定为第一优先）

- JS 的价值：增强导航体验（Swup）、增强动效（VT/过渡）、增强交互（评论区/灯箱/组件）。
- **禁止**：把主要内容渲染交给 JS；把全站状态堆到 `window`；用一个大脚本塞所有功能且无法按需控制。
- **允许**：少量全局命名空间（例如 `window.PS`），但 API 必须小而稳定，并且可被禁用。
- 初始化时机：尽量 `defer` + DOMContentLoaded 后初始化；昂贵任务用 `requestIdleCallback`（并提供降级）。

---

## 6. 动画与转场（预期效果与规范）

> 现实前提：对这个主题来说，“有 JS 才是常态完美”。因此默认以 Swup +（可用则启用）View Transitions 为主；但 **VT 不支持/Swup 失败** 时，仍要落到同一套“普通卡片转场”上，保证观感一致。

### 6.1 统一动效语言（全站一致）
- 动画只走合成层：只允许 `transform/opacity`（禁用布局动画作为默认方案）。
- 速度与节奏：同类动画时长/缓动必须一致（页面转场、列表卡片、主题切换不要“各唱各的”）。
- 观感基调：轻、干净、不过度（不做夸张弹跳、不做强烈景深）。
- 无障碍：`prefers-reduced-motion: reduce` 时，所有转场要么关闭、要么显著缩短并去掉位移/缩放。

### 6.2 两种转场形态（必须同时成立）

1) **形态 A：共享元素 VT（丝滑 morph）**
   - 适用：**主卡片（文章卡片） ↔ 列表卡片** 的互相切换（典型：`index.php`/`archive.php` 列表 → `post.php` 文章详情；以及从文章返回列表）。
   - 体验关键词：**卡片“变身”成文章（或反向）**，主体连续、无断裂、无额外缩放打架。

2) **形态 B：普通卡片转场（默认）**
   - 适用：除形态 A 之外的所有情况（`page.php`、没有共享元素的文章卡片跳转、任意 VT 不支持/被禁用、任意 Swup 失败回退）。
   - 体验关键词：**卡片轻微放大进入 + 退出**，简单、稳定、可预期。

> 判定规则：满足形态 A 的条件时 **A 优先**；否则一律走形态 B。

### 6.3 形态 A：共享元素 VT（主卡片 ↔ 列表卡片）
- 覆盖范围（预期效果）：
  - 列表页（`index.php`/`archive.php`）点击某个文章卡片 → 文章页：该卡片主体自然 morph 为文章页主容器。
  - 文章页返回列表页：文章页主容器 morph 回列表中的“同一篇文章卡片”。
- 触发条件（规范）：
  - **必须能精确识别“同一篇文章”**（例如基于 permalink/slug/id 的稳定 key，不过要确保在自定义了页面url的情况下也能正常，所以最好设计一个好思路）。
  - 只对“确实存在匹配对象”的导航启用共享元素；否则退回形态 B（不能为了强行 VT 导致乱飞/串台）。
- 视觉要求（规范）：
  - 共享元素只负责“主体连续”，不要叠加额外的卡片 zoom 进入/退出导致双重缩放。
  - 列表中**非共享的其他卡片**只允许轻量淡出/轻微位移（不做复杂波浪退出抢戏）。
  - 文章页中**非共享的内容区域**（正文、评论等）只做轻量淡入/上移，且应晚于主体 morph（避免内容先跳出来再被 morph 覆盖）。
- 性能与稳定性底线：
  - VT 期间允许做“降噪”（如隐藏复杂区域），但必须保证动画结束后状态可恢复且不闪烁。
  - 任意共享元素标记必须可清理，不能残留到下一次导航造成错配。

### 6.4 形态 B：普通卡片转场（默认卡片放大进入 + 退出）
- 适用范围（预期效果）：
  - `page.php` 的页面卡片。
  - 文章卡片跳转但无法匹配共享元素时（例如从搜索结果、随机页、或无 key 场景进入文章页）。
  - 浏览器不支持 VT / Swup native 关闭 / Swup 失败回退时的“兜底转场”。
- 视觉要求（规范）：
  - **退出**：当前主卡片轻微缩小（或上移）+ 淡出，避免“突然消失”。
  - **进入**：新主卡片从轻微缩小态进入到 1:1 + 淡入（视觉上是“发大进入”），并保持文字清晰不抖动。
  - 列表页进入允许轻量 stagger（可选），但必须克制：卡片多时不能拖慢首屏可读性。
- 交互要求（规范）：
  - 转场必须可被打断（快速连续点击/返回不会卡死在半透明或隐藏态）。
  - 任何“预隐藏”机制都必须有超时/兜底清理，避免内容永久不可见。

### 6.5 冲突与优先级（避免“打架”）
- 形态 A 启用时：普通卡片转场 **不得作用于共享元素主体**（避免 morph + zoom 双重缩放）。
- 形态 B 启用时：不得残留任何共享元素标记（避免下次导航误判为形态 A）。

### 6.6 降级与无障碍（写成硬规范）
- `prefers-reduced-motion: reduce`：关闭形态 A/B 的位移/缩放；允许保留极短的淡入淡出或直接无动画。
- VT 不支持：一律走形态 B（不要尝试模拟“伪 VT”）。
- Swup 失败/禁用：允许无动画直接跳转，但页面不应出现“预隐藏未清理”的残留状态。

### 6.7 主题切换（VT）
- 主题切换属于“增强中的增强”：支持 `document.startViewTransition` 时允许做轻量淡变；不支持或 reduced motion 时直接切换 `data-theme`。
- 主题切换的节奏应与转场同一动效语言（时长/缓动接近），避免割裂感。

---

## 7. 目录建议（基于当前仓库，渐进优化）

> 不引入构建链时，目录以“能看懂、好维护”为主。

- `functions/`：按领域拆分（已存在：cache/article/sidebar/shortcodes/common/render 等），继续保持“小文件、单职责”。
- `js/`：按模块拆分（可保留 `lib/` 第三方文件）；建议新增 `js/modules/` 存放自研模块。
- `css/`：保留现有结构；建议新增 `css/tokens.css`（或类似）集中变量，再由其他 CSS 引用。
- `partials/`：模板片段（逐步迁移，不要求一次到位）。

> 如果未来确实要引入构建链：把它当作“可选高级用法”，并确保 release 包含可直接使用的 `dist` 产物。

---

## 8. 开发与提交约定（轻量版）

- 每个改动必须回答三件事：
  1) 解决了什么问题（可复现）
  2) 对无 JS / Swup 失败时是否仍可用
  3) 性能风险点在哪里（是否新增长任务、是否更频繁触发布局）
- 引入新依赖必须说明：替代方案、体积与维护成本、以及是否能按需加载/可禁用。

---

## 9. 内容渲染（PHP 渲染管道）

> 目标：把“短代码/TOC/图片处理/表情”等都收敛到**一个可缓存、可回归、可解释**的渲染入口。

- 保持 `renderPostContent($content)` 作为文章内容渲染的**唯一入口**，并明确每一步处理的顺序与职责（短代码 → 组件解析 → 表格/图片增强 → TOC 等）。
- 渲染步骤尽量满足：**可重复执行（idempotent）** 或有明确的“已处理标记”，避免 Swup/重复渲染导致二次包裹。
- 缓存策略以“可解释”为准：
  - cache key 至少包含主题版本 + 原始内容摘要；
  - 需要时把关键设置项（影响输出的 option）纳入 key（避免“改设置但缓存不刷新”）。
- 尽量减少 `$GLOBALS` 作为跨函数通信；可以先维持现状，但在 Phase 2/3 再逐步改为“结构化返回值”（例如返回 `['content' => ..., 'toc' => ...]`）。
- 尽可能减少js需求，把能处理的全处理了，php输出一切html结构和对应效果。例如评论区的OWO.js，可以做成类似OWO.php的存在，对于结构的解析可以让php来。

---

## 10. 风险与回滚（写清楚，才敢重构）

- Swup/Head 更新：一旦出现 meta/title 异常或脚本重复初始化，必须可快速禁用 Swup 回退到原生跳转。
- 大文件 JS（如 `PureSuck_Swup.js`）：拆分重构要先建立“最小回归用例”（导航、滚动、动画、评论、图片放大）。
- 任何影响内容输出的改动（短代码/渲染管道）：必须用几篇典型文章做人工回归，避免线上内容“变形/丢失”。
