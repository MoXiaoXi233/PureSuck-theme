(() => {
    class OwO {
        static _dataPromiseCache = new Map();

        constructor(option) {
            const defaultOption = {
                logo: 'OωO表情',
                container: document.getElementsByClassName('OwO')[0],
                target: document.getElementsByTagName('textarea')[0],
                position: 'up',
                width: '100%',
                maxHeight: '260px',
                api: window.THEME_URL + '/js/OwO.json'
            };
            option = option || {};
            for (const k in defaultOption) if (!(k in option)) option[k] = defaultOption[k];

            this.container = option.container;
            this.target = option.target;
            if (!this.container || !this.target) return;

            this.maxHeight = Math.max(120, parseInt(option.maxHeight, 10) || 260);
            this._open = false;
            this._scrolling = false;
            this._scrollRAF = 0;
            this._scrollTimer = 0;

            this._heightCache = [];
            this._pkgMetrics = null;
            this._imgBound = new WeakSet();
            this._settleTimer = 0;

            this._loadData(option.api).then((data) => {
                // ★ 新增：只在这里做一次规范化
                this.odata = this._normalizeData(data || {});
                this.init(option);
            }).catch(() => { });
        }

        _loadData(api) {
            if (!api) return Promise.resolve({});
            if (OwO._dataPromiseCache.has(api)) return OwO._dataPromiseCache.get(api);

            const p = fetch(api, { cache: 'force-cache' })
                .then(r => {
                    if (!r.ok) throw new Error(r.statusText);
                    return r.json();
                });

            OwO._dataPromiseCache.set(api, p);
            return p;
        }

        _idle(cb, timeout = 1200) {
            if (window.requestIdleCallback) return requestIdleCallback(cb, { timeout });
            return setTimeout(() => cb({ timeRemaining: () => 0, didTimeout: true }), 0);
        }

        // ★ 新增：数据规范化（不影响任何既有逻辑）
        _normalizeData(data) {
            const themeUrl = window.THEME_URL || '';
            const imageBase = themeUrl ? themeUrl + '/images/' : '';

            Object.values(data).forEach(pkg => {
                const type = pkg.type || 'emoticon';
                if (type !== 'image') return;

                const base = pkg.base || '';
                (pkg.container || []).forEach(item => {
                    if (!item.icon) return;

                    // 已是绝对路径 / 外链 → 原样保留
                    if (/^(https?:)?\/\//.test(item.icon)) return;

                    // 已是 /usr/... 这种老写法 → 原样保留
                    if (item.icon.startsWith('/')) return;

                    // 新规范：相对 images/
                    item.icon = imageBase + base.replace(/^\/+|\/+$/g, '/') + item.icon;
                });
            });

            return data;
        }

        init(option) {
            this.packages = Object.keys(this.odata || {});
            if (!this.packages.length) return;

            let html = `<div class="OwO-logo"><span>${option.logo}</span></div><div class="OwO-body"><div class="OwO-panel"><div class="OwO-viewport">`;

            this.packages.forEach((pkg, idx) => {
                const pd = this.odata[pkg];
                const type = pd.type || 'emoticon';
                html += `<ul class="OwO-items OwO-items-${type}" ${idx === 0 ? '' : 'hidden'}>`;
                (pd.container || []).forEach(item => {
                    const text = item.text || '';
                    const input = item.input || item.icon || '';
                    const icon = item.icon || '';
                    if (type === 'image') {
                        const w = pd.width ? ` style="width:${pd.width}"` : '';
                        html += `<li class="OwO-item" title="${text}" data-input="${input}"><img src="${icon}" alt="${text}" loading="lazy"${w}></li>`;
                    } else {
                        html += `<li class="OwO-item" title="${text}" data-input="${input}">${icon}</li>`;
                    }
                });
                html += `</ul>`;
            });

            html += `</div><div class="OwO-bar"><ul class="OwO-packages">`;
            this.packages.forEach((pkg, idx) => {
                html += `<li class="${idx === 0 ? 'OwO-package-active' : ''}" data-idx="${idx}"><span>${pkg}</span></li>`;
            });
            html += `</ul><div class="OwO-indicator"></div></div></div></div>`;

            this.container.innerHTML = html;

            this.logo = this.container.querySelector('.OwO-logo');
            this.body = this.container.querySelector('.OwO-body');
            this.panel = this.container.querySelector('.OwO-panel');
            this.viewport = this.container.querySelector('.OwO-viewport');
            this.indicator = this.container.querySelector('.OwO-indicator');
            this.packagesEle = this.container.querySelector('.OwO-packages');
            this.lists = Array.from(this.container.querySelectorAll('.OwO-items'));

            this._cachePkgMetrics();

            this.logo.addEventListener('click', () => this.toggle());

            this.body.addEventListener('click', (e) => {
                const it = e.target.closest('.OwO-item');
                if (!it) return;

                const textToInsert = it.getAttribute('data-input') || '';
                const el = this.target;
                el.focus();
                const start = el.selectionStart ?? (el.value || '').length;
                const end = el.selectionEnd ?? start;
                try {
                    el.setRangeText(textToInsert, start, end, 'end');
                } catch {
                    const v = el.value || '';
                    el.value = v.slice(0, start) + textToInsert + v.slice(end);
                }

                this.toggle(false);
            });

            this.packagesEle.addEventListener('click', (e) => {
                const li = e.target.closest('li');
                if (!li) return;
                const idx = parseInt(li.getAttribute('data-idx'), 10);
                if (!Number.isFinite(idx)) return;
                this.tab(idx, true);
            });

            this.packagesEle.addEventListener('scroll', () => {
                if (!this._open) return;
                this._scrolling = true;
                this.container.classList.add('OwO-snap-indicator');

                this._syncIndicatorFast();

                clearTimeout(this._scrollTimer);
                this._scrollTimer = setTimeout(() => {
                    this._scrolling = false;
                    this.container.classList.remove('OwO-snap-indicator');
                    this._syncIndicatorFast();
                }, 120);
            }, { passive: true });

            document.addEventListener('click', (e) => {
                if (!this._open) return;
                if (this.container.contains(e.target)) return;
                this.toggle(false);
            }, true);

            window.addEventListener('resize', () => {
                this._cachePkgMetrics();
                if (!this._open) return;
                this.syncHeight(true);
                this.syncIndicator(true);
            }, { passive: true });

            this._ro = new ResizeObserver(() => {
                if (!this._open) return;
                this.syncHeight(true);
                this.syncIndicator(false);
            });
            this._ro.observe(this.panel);

            this.tab(0, false);
            this.toggle(false);

            this._idle(() => this._prewarm(), 1500);
        }

        _cachePkgMetrics() {
            try {
                const lis = Array.from(this.packagesEle.querySelectorAll('li[data-idx]'));
                this._pkgMetrics = lis.map(li => ({
                    w: li.offsetWidth || 0,
                    x: li.offsetLeft || 0
                }));
            } catch {
                this._pkgMetrics = null;
            }
        }


        _syncIndicatorFast() {
            if (!this._pkgMetrics || !this._pkgMetrics.length) return;
            const act = this.packagesEle.querySelector('.OwO-package-active');
            if (!act) return;

            const idx = parseInt(act.getAttribute('data-idx'), 10);
            if (!Number.isFinite(idx)) return;

            const m = this._pkgMetrics[idx];
            if (!m) return;

            const padding = 20;
            const w = Math.max(18, m.w - padding);
            const x = (m.x - (this.packagesEle.scrollLeft || 0));

            this.indicator.style.width = `${w}px`;
            this.indicator.style.transform = `translateX(${x}px)`;
        }

        _bindActiveImagesReflow() {
            const list = this.container.querySelector('.OwO-items:not([hidden])');
            if (!list) return;

            const imgs = list.querySelectorAll('img');
            if (!imgs.length) return;

            imgs.forEach(img => {
                if (this._imgBound.has(img)) return;
                this._imgBound.add(img);

                const onDone = () => {
                    if (!this._open) return;

                    this.syncHeight(true);
                };


                if (img.complete) return;

                img.addEventListener('load', onDone, { once: true });
                img.addEventListener('error', onDone, { once: true });
            });
        }


        _scheduleHeightSettle() {
            clearTimeout(this._settleTimer);
            this._settleTimer = setTimeout(() => {
                if (!this._open) return;
                this.syncHeight(false);
            }, 80);
        }

        _prewarm() {
            try {

                const srcs = [];
                this.packages.forEach((pkg) => {
                    const pd = this.odata[pkg] || {};
                    if ((pd.type || 'emoticon') !== 'image') return;
                    (pd.container || []).forEach((it) => {
                        if (it && it.icon) srcs.push(it.icon);
                    });
                });

                let i = 0;
                const step = () => {
                    const end = Math.min(i + 10, srcs.length);
                    for (; i < end; i++) {
                        const img = new Image();
                        img.decoding = 'async';
                        img.loading = 'eager';
                        img.src = srcs[i];
                        if (img.decode) img.decode().catch(() => { });
                    }
                    if (i < srcs.length) this._idle(step, 1500);
                };
                if (srcs.length) this._idle(step, 1500);


                this.container.setAttribute('data-owo-measure', '1');

                const hiddenState = this.lists.map((ul) => ul.hasAttribute('hidden'));
                this.lists.forEach((ul) => ul.removeAttribute('hidden'));

                this._heightCache = this.lists.map((ul) => ul.scrollHeight || 0);

                this.lists.forEach((ul, idx) => {
                    if (hiddenState[idx]) ul.setAttribute('hidden', '');
                });

                this.container.removeAttribute('data-owo-measure');
            } catch {
                try { this.container.removeAttribute('data-owo-measure'); } catch { }
            }
        }
        toggle(force) {
            const next = typeof force === 'boolean' ? force : !this._open;
            this._open = next;
            this.container.classList.toggle('OwO-open', next);

            if (next) {
                this.syncIndicator(false);
                this.syncHeight(true);
            } else {
                this.viewport.style.maxHeight = '0px';
            }
        }


        tab(index, animate = true) {
            const cur = this.container.querySelector('.OwO-items:not([hidden])');
            if (cur) cur.setAttribute('hidden', '');
            const next = this.lists[index];
            if (next) next.removeAttribute('hidden');

            const act = this.packagesEle.querySelector('.OwO-package-active');
            if (act) act.classList.remove('OwO-package-active');
            const li = this.packagesEle.querySelector(`li[data-idx="${index}"]`);
            if (li) li.classList.add('OwO-package-active');


            this._syncIndicatorFast();
            this._bindActiveImagesReflow();
            this._scheduleHeightSettle();
            if (this._open) {
                this.syncHeight(animate);
            } else {
                this.syncIndicator(false);
            }
        }

        syncHeight() {
            const list = this.container.querySelector('.OwO-items:not([hidden])');
            if (!list) return;

            list.style.maxHeight = `${this.maxHeight}px`;

            const sh = list.scrollHeight;
            const targetH = Math.min(sh, this.maxHeight);

            list.style.overflow = sh > this.maxHeight ? 'auto' : 'hidden';


            this.viewport.style.maxHeight = `${targetH}px`;
        }



        syncIndicator(animate = true) {
            const li = this.packagesEle.querySelector('.OwO-package-active');
            if (!li) return;


            const idx = parseInt(li.getAttribute('data-idx'), 10);
            if (Number.isFinite(idx) && this._pkgMetrics && this._pkgMetrics[idx]) {
                const m = this._pkgMetrics[idx];
                const padding = 20;
                const w = Math.max(18, m.w - padding);
                const x = (m.x - (this.packagesEle.scrollLeft || 0));

                if (!animate) {
                    this.indicator.style.width = `${w}px`;
                    this.indicator.style.transform = `translateX(${x}px)`;
                    return;
                }

                this.container.classList.remove('OwO-snap-indicator');

                const cs = getComputedStyle(this.indicator);
                this.indicator.style.width = cs.width;
                this.indicator.style.transform = cs.transform === 'none' ? 'translateX(0px)' : cs.transform;
                this.indicator.getBoundingClientRect();

                requestAnimationFrame(() => {
                    this.indicator.style.width = `${w}px`;
                    this.indicator.style.transform = `translateX(${x}px)`;
                });
                return;
            }


            const wrapRect = this.packagesEle.getBoundingClientRect();
            const liRect = li.getBoundingClientRect();
            const w = Math.max(18, liRect.width);
            const x = liRect.left - wrapRect.left;

            if (!animate) {
                this.indicator.style.width = `${w}px`;
                this.indicator.style.transform = `translateX(${x}px)`;
                return;
            }

            this.container.classList.remove('OwO-snap-indicator');

            const cs = getComputedStyle(this.indicator);
            this.indicator.style.width = cs.width;
            this.indicator.style.transform = cs.transform === 'none' ? 'translateX(0px)' : cs.transform;
            this.indicator.getBoundingClientRect();

            requestAnimationFrame(() => {
                this.indicator.style.width = `${w}px`;
                this.indicator.style.transform = `translateX(${x}px)`;
            });
        }
    }

    if (typeof module !== 'undefined' && typeof module.exports !== 'undefined') {
        module.exports = OwO;
    } else {
        window.OwO = OwO;
    }
})();

function initializeCommentsOwO() {
    const container = document.getElementsByClassName('OwO')[0];
    const target = document.getElementsByClassName('OwO-textarea')[0];
    if (!container || !target) return;

    const owo = new window.OwO({
        logo: 'OωO表情',
        container,
        target,
        api: window.THEME_URL + '/js/OwO.json',
        position: 'up',
        width: '100%',
        maxHeight: '260px'
    });

    const btn = document.getElementById('owo-button');
    if (btn) btn.addEventListener('click', () => owo.toggle());
}

initializeCommentsOwO();
