(() => {
    class OwO {
        static _dataPromiseCache = new Map();

        constructor(option) {
            const defaultOption = {
                logo: 'OωO表情',
                container: document.getElementsByClassName('OwO')[0],
                target: document.getElementsByTagName('textarea')[0],
                position: 'up',
                width: '100%',
                maxHeight: '260px',
                api: window.THEME_URL + '/js/OwO.json'
            };
            option = option || {};
            for (const k in defaultOption) if (!(k in option)) option[k] = defaultOption[k];

            this.container = option.container;
            this.target = option.target;
            if (!this.container || !this.target) return;

            this.maxHeight = Math.max(120, parseInt(option.maxHeight, 10) || 260);
            this._open = false;
            this._scrolling = false;
            this._scrollRAF = 0;
            this._scrollTimer = 0;

            this._heightCache = [];
            this._pkgMetrics = null;
            this._imgBound = new WeakSet();
            this._settleTimer = 0;

            this._loadData(option.api).then((data) => {
                // ★ 新增：只在这里做一次规范化
                this.odata = this._normalizeData(data || {});
                this.init(option);
            }).catch(() => { });
        }

        _loadData(api) {
            if (!api) return Promise.resolve({});
            if (OwO._dataPromiseCache.has(api)) return OwO._dataPromiseCache.get(api);

            const p = fetch(api, { cache: 'force-cache' })
                .then(r => {
                    if (!r.ok) throw new Error(r.statusText);
                    return r.json();
                });

            OwO._dataPromiseCache.set(api, p);
            return p;
        }

        _idle(cb, timeout = 1200) {
            if (window.requestIdleCallback) return requestIdleCallback(cb, { timeout });
            return setTimeout(() => cb({ timeRemaining: () => 0, didTimeout: true }), 0);
        }

        // ★ 新增：数据规范化（不影响任何既有逻辑）
        _normalizeData(data) {
            const themeUrl = window.THEME_URL || '';
            const imageBase = themeUrl ? themeUrl + '/images/' : '';

            Object.values(data).forEach(pkg => {
                const type = pkg.type || 'emoticon';
                if (type !== 'image') return;

                const base = pkg.base || '';
                (pkg.container || []).forEach(item => {
                    if (!item.icon) return;

                    // 已是绝对路径 / 外链 → 原样保留
                    if (/^(https?:)?\/\//.test(item.icon)) return;

                    // 已是 /usr/... 这种老写法 → 原样保留
                    if (item.icon.startsWith('/')) return;

                    // 新规范：相对 images/
                    item.icon = imageBase + base.replace(/^\/+|\/+$/g, '/') + item.icon;
                });
            });

            return data;
        }

        init(option) {
            this.packages = Object.keys(this.odata || {});
            if (!this.packages.length) return;

            let html = `<div class="OwO-logo"><span>${option.logo}</span></div><div class="OwO-body"><div class="OwO-panel"><div class="OwO-viewport">`;

            // ★ 存储需要延迟渲染的emoji数据
            this._lazyRenderData = [];

            this.packages.forEach((pkg, idx) => {
                const pd = this.odata[pkg];
                const type = pd.type || 'emoticon';
                const items = pd.container || [];

                html += `<ul class="OwO-items OwO-items-${type}" data-pkg-idx="${idx}" ${idx === 0 ? '' : 'hidden'}>`;

                // ★ 对emoji类型使用分批渲染
                if (type === 'emoji' && items.length > 30) {
                    // 首次只渲染前30个
                    const firstBatch = items.slice(0, 30);
                    const remaining = items.slice(30);

                    firstBatch.forEach(item => {
                        const text = item.text || '';
                        const input = item.input || item.icon || '';
                        const icon = item.icon || '';
                        html += `<li class="OwO-item" title="${text}" data-input="${input}">${icon}</li>`;
                    });

                    // 保存剩余的emoji供后续渲染
                    if (remaining.length > 0) {
                        this._lazyRenderData.push({ pkgIdx: idx, items: remaining });
                    }
                } else {
                    // 其他类型正常渲染
                    items.forEach(item => {
                        const text = item.text || '';
                        const input = item.input || item.icon || '';
                        const icon = item.icon || '';
                        if (type === 'image') {
                            const w = pd.width ? ` style="width:${pd.width}"` : '';
                            html += `<li class="OwO-item" title="${text}" data-input="${input}"><img src="${icon}" alt="${text}" loading="lazy"${w}></li>`;
                        } else {
                            html += `<li class="OwO-item" title="${text}" data-input="${input}">${icon}</li>`;
                        }
                    });
                }

                html += `</ul>`;
            });

            html += `</div><div class="OwO-bar"><ul class="OwO-packages">`;
            this.packages.forEach((pkg, idx) => {
                html += `<li class="${idx === 0 ? 'OwO-package-active' : ''}" data-idx="${idx}"><span>${pkg}</span></li>`;
            });
            html += `</ul><div class="OwO-indicator"></div></div></div></div>`;

            this.container.innerHTML = html;

            this.logo = this.container.querySelector('.OwO-logo');
            this.body = this.container.querySelector('.OwO-body');
            this.panel = this.container.querySelector('.OwO-panel');
            this.viewport = this.container.querySelector('.OwO-viewport');
            this.indicator = this.container.querySelector('.OwO-indicator');
            this.packagesEle = this.container.querySelector('.OwO-packages');
            this.lists = Array.from(this.container.querySelectorAll('.OwO-items'));

            // 延迟缓存几何属性到首次打开时，避免初始化时触发 reflow
            this._pkgMetricsCached = false;

            this.logo.addEventListener('click', () => this.toggle());

            this.body.addEventListener('click', (e) => {
                const it = e.target.closest('.OwO-item');
                if (!it) return;

                const textToInsert = it.getAttribute('data-input') || '';
                const el = this.target;
                el.focus();
                const start = el.selectionStart ?? (el.value || '').length;
                const end = el.selectionEnd ?? start;
                try {
                    el.setRangeText(textToInsert, start, end, 'end');
                } catch {
                    const v = el.value || '';
                    el.value = v.slice(0, start) + textToInsert + v.slice(end);
                }

                this.toggle(false);
            });

            this.packagesEle.addEventListener('click', (e) => {
                const li = e.target.closest('li');
                if (!li) return;
                const idx = parseInt(li.getAttribute('data-idx'), 10);
                if (!Number.isFinite(idx)) return;
                this.tab(idx, true);
            });

            this.packagesEle.addEventListener('scroll', () => {
                if (!this._open) return;
                this._scrolling = true;
                this.container.classList.add('OwO-snap-indicator');

                this._syncIndicatorFast();

                clearTimeout(this._scrollTimer);
                this._scrollTimer = setTimeout(() => {
                    this._scrolling = false;
                    this.container.classList.remove('OwO-snap-indicator');
                    this._syncIndicatorFast();
                }, 120);
            }, { passive: true });

            document.addEventListener('click', (e) => {
                if (!this._open) return;
                if (this.container.contains(e.target)) return;
                this.toggle(false);
            }, true);

            window.addEventListener('resize', () => {
                // 只在已缓存的情况下才重新缓存（避免未打开时触发 reflow）
                if (this._pkgMetricsCached) {
                    this._cachePkgMetrics();
                }
                if (!this._open) return;
                this.syncHeight(true);
                this.syncIndicator(true);
            }, { passive: true });

            this._ro = new ResizeObserver(() => {
                if (!this._open) return;
                this.syncHeight(true);
                this.syncIndicator(false);
            });
            this._ro.observe(this.panel);

            this.tab(0, false);
            this.toggle(false);

            // ★ 延迟渲染剩余的emoji
            this._idle(() => this._lazyRenderEmojis(), 100);

            this._idle(() => this._prewarm(), 1500);
        }

        // ★ 新增：延迟渲染剩余emoji
        _lazyRenderEmojis() {
            if (!this._lazyRenderData || !this._lazyRenderData.length) return;

            try {
                this._lazyRenderData.forEach(({ pkgIdx, items }) => {
                    const ul = this.container.querySelector(`ul[data-pkg-idx="${pkgIdx}"]`);
                    if (!ul) return;

                    // 分批添加，每批10个，避免一次性渲染太多
                    let i = 0;
                    const batchSize = 10;

                    const addBatch = () => {
                        const end = Math.min(i + batchSize, items.length);
                        const fragment = document.createDocumentFragment();

                        for (; i < end; i++) {
                            const item = items[i];
                            const text = item.text || '';
                            const input = item.input || item.icon || '';
                            const icon = item.icon || '';

                            const li = document.createElement('li');
                            li.className = 'OwO-item';
                            li.title = text;
                            li.setAttribute('data-input', input);
                            li.textContent = icon;

                            fragment.appendChild(li);
                        }

                        ul.appendChild(fragment);

                        // 如果还有剩余，继续下一批
                        if (i < items.length) {
                            this._idle(addBatch, 50);
                        }
                    };

                    addBatch();
                });

                // 清理数据
                this._lazyRenderData = null;
            } catch (error) {
                console.warn('[OwO] Lazy render failed:', error);
            }
        }

        _cachePkgMetrics() {
            try {
                const lis = Array.from(this.packagesEle.querySelectorAll('li[data-idx]'));
                this._pkgMetrics = lis.map(li => ({
                    w: li.offsetWidth || 0,
                    x: li.offsetLeft || 0
                }));
            } catch {
                this._pkgMetrics = null;
            }
        }


        _syncIndicatorFast() {
            if (!this._pkgMetrics || !this._pkgMetrics.length) return;
            const act = this.packagesEle.querySelector('.OwO-package-active');
            if (!act) return;

            const idx = parseInt(act.getAttribute('data-idx'), 10);
            if (!Number.isFinite(idx)) return;

            const m = this._pkgMetrics[idx];
            if (!m) return;

            const padding = 20;
            const w = Math.max(18, m.w - padding);
            const x = (m.x - (this.packagesEle.scrollLeft || 0));

            this.indicator.style.width = `${w}px`;
            this.indicator.style.transform = `translateX(${x}px)`;
        }

        _bindActiveImagesReflow() {
            const list = this.container.querySelector('.OwO-items:not([hidden])');
            if (!list) return;

            const imgs = list.querySelectorAll('img');
            if (!imgs.length) return;

            imgs.forEach(img => {
                if (this._imgBound.has(img)) return;
                this._imgBound.add(img);

                const onDone = () => {
                    if (!this._open) return;

                    this.syncHeight(true);
                };


                if (img.complete) return;

                img.addEventListener('load', onDone, { once: true });
                img.addEventListener('error', onDone, { once: true });
            });
        }


        _scheduleHeightSettle() {
            clearTimeout(this._settleTimer);
            this._settleTimer = setTimeout(() => {
                if (!this._open) return;
                this.syncHeight(false);
            }, 80);
        }

        _prewarm() {
            try {

                const srcs = [];
                this.packages.forEach((pkg) => {
                    const pd = this.odata[pkg] || {};
                    if ((pd.type || 'emoticon') !== 'image') return;
                    (pd.container || []).forEach((it) => {
                        if (it && it.icon) srcs.push(it.icon);
                    });
                });

                let i = 0;
                const step = () => {
                    const end = Math.min(i + 10, srcs.length);
                    for (; i < end; i++) {
                        const img = new Image();
                        img.decoding = 'async';
                        img.loading = 'eager';
                        img.src = srcs[i];
                        if (img.decode) img.decode().catch(() => { });
                    }
                    if (i < srcs.length) this._idle(step, 1500);
                };
                if (srcs.length) this._idle(step, 1500);

                // 移除无用的高度预缓存（从未被使用，且触发59ms强制重排）
            } catch {
                // 错误处理
            }
        }
        toggle(force) {
            const next = typeof force === 'boolean' ? force : !this._open;
            this._open = next;
            this.container.classList.toggle('OwO-open', next);

            if (next) {
                // 首次打开时缓存几何属性（延迟到用户交互时，避免初始化时触发 reflow）
                if (!this._pkgMetricsCached) {
                    this._pkgMetricsCached = true;
                    // 使用 RAF 确保 DOM 已渲染
                    requestAnimationFrame(() => {
                        this._cachePkgMetrics();
                        this.syncIndicator(false);
                    });
                } else {
                    this.syncIndicator(false);
                }
                this.syncHeight(true);
            } else {
                this.viewport.style.maxHeight = '0px';
            }
        }


        tab(index, animate = true) {
            const cur = this.container.querySelector('.OwO-items:not([hidden])');
            if (cur) cur.setAttribute('hidden', '');
            const next = this.lists[index];
            if (next) next.removeAttribute('hidden');

            const act = this.packagesEle.querySelector('.OwO-package-active');
            if (act) act.classList.remove('OwO-package-active');
            const li = this.packagesEle.querySelector(`li[data-idx="${index}"]`);
            if (li) li.classList.add('OwO-package-active');


            this._syncIndicatorFast();
            this._bindActiveImagesReflow();
            this._scheduleHeightSettle();
            if (this._open) {
                this.syncHeight(animate);
            } else {
                this.syncIndicator(false);
            }
        }

        syncHeight() {
            const list = this.container.querySelector('.OwO-items:not([hidden])');
            if (!list) return;

            list.style.maxHeight = `${this.maxHeight}px`;

            const sh = list.scrollHeight;
            const targetH = Math.min(sh, this.maxHeight);

            list.style.overflow = sh > this.maxHeight ? 'auto' : 'hidden';


            this.viewport.style.maxHeight = `${targetH}px`;
        }



        syncIndicator(animate = true) {
            const li = this.packagesEle.querySelector('.OwO-package-active');
            if (!li) return;


            const idx = parseInt(li.getAttribute('data-idx'), 10);
            if (Number.isFinite(idx) && this._pkgMetrics && this._pkgMetrics[idx]) {
                const m = this._pkgMetrics[idx];
                const padding = 20;
                const w = Math.max(18, m.w - padding);
                const x = (m.x - (this.packagesEle.scrollLeft || 0));

                if (!animate) {
                    this.indicator.style.width = `${w}px`;
                    this.indicator.style.transform = `translateX(${x}px)`;
                    return;
                }

                // ✅ 使用双重 RAF 替代 getBoundingClientRect() 强制重排技巧
                this.container.classList.remove('OwO-snap-indicator');

                const cs = getComputedStyle(this.indicator);
                const currentWidth = cs.width;
                const currentTransform = cs.transform === 'none' ? 'translateX(0px)' : cs.transform;

                this.indicator.style.width = currentWidth;
                this.indicator.style.transform = currentTransform;

                // ✅ 双重 RAF 确保浏览器已应用初始样式，避免 getBoundingClientRect() 强制重排
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        this.indicator.style.width = `${w}px`;
                        this.indicator.style.transform = `translateX(${x}px)`;
                    });
                });
                return;
            }


            const wrapRect = this.packagesEle.getBoundingClientRect();
            const liRect = li.getBoundingClientRect();
            const w = Math.max(18, liRect.width);
            const x = liRect.left - wrapRect.left;

            if (!animate) {
                this.indicator.style.width = `${w}px`;
                this.indicator.style.transform = `translateX(${x}px)`;
                return;
            }

            // ✅ 使用双重 RAF 替代 getBoundingClientRect() 强制重排技巧
            this.container.classList.remove('OwO-snap-indicator');

            const cs = getComputedStyle(this.indicator);
            const currentWidth = cs.width;
            const currentTransform = cs.transform === 'none' ? 'translateX(0px)' : cs.transform;

            this.indicator.style.width = currentWidth;
            this.indicator.style.transform = currentTransform;

            // ✅ 双重 RAF 确保浏览器已应用初始样式，避免 getBoundingClientRect() 强制重排
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    this.indicator.style.width = `${w}px`;
                    this.indicator.style.transform = `translateX(${x}px)`;
                });
            });
        }
    }

    if (typeof module !== 'undefined' && typeof module.exports !== 'undefined') {
        module.exports = OwO;
    } else {
        window.OwO = OwO;
    }
})();

/**
 * OwO 实例管理器 - 与 Swup 深度集成
 * 特性：
 * - 自动生命周期管理（随 Swup 页面切换自动清理/初始化）
 * - 优雅的事件监听器管理（使用 AbortController）
 * - 智能实例复用（避免不必要的重建）
 * - 完善的错误处理和降级方案
 */
const OwoManager = {
    // 当前活动实例
    instance: null,
    // 当前容器和目标元素的引用
    container: null,
    target: null,
    // 事件监听器控制器（用于批量清理）
    abortController: null,
    // 初始化状态
    isInitializing: false,
    // 调试模式
    debug: false,

    /**
     * 日志输出（仅在调试模式下）
     */
    log(...args) {
        if (this.debug) {
            console.log('[OwoManager]', ...args);
        }
    },

    /**
     * 初始化或复用 OwO 实例
     * @param {Object} options - 配置选项
     * @param {boolean} options.force - 强制重新初始化
     * @returns {boolean} 是否成功初始化
     */
    init(options = {}) {
        const { force = false } = options;

        // 防止并发初始化
        if (this.isInitializing) {
            this.log('初始化进行中，跳过');
            return false;
        }

        const container = document.getElementsByClassName('OwO')[0];
        const target = document.getElementsByClassName('OwO-textarea')[0];

        // 容器或目标不存在，清理并退出
        if (!container || !target) {
            this.log('容器或目标不存在，清理实例');
            this.destroy();
            return false;
        }

        // 智能复用：容器和目标未变化，且不强制重建
        if (!force && this.instance && this.container === container && this.target === target) {
            this.log('实例复用，跳过初始化');
            return true;
        }

        // 容器或目标变化，销毁旧实例
        if (this.instance && (this.container !== container || this.target !== target)) {
            this.log('容器或目标变化，销毁旧实例');
            this.destroy();
        }

        // 开始初始化
        this.isInitializing = true;

        try {
            // 创建新的 AbortController 用于事件管理
            this.abortController = new AbortController();

            // 保存引用
            this.container = container;
            this.target = target;

            // 创建 OwO 实例
            this.instance = new window.OwO({
                logo: 'OωO表情',
                container,
                target,
                api: window.THEME_URL + '/js/OwO.json',
                position: 'up',
                width: '100%',
                maxHeight: '260px'
            });

            // 绑定按钮事件（使用 AbortController 管理）
            this.bindButtonEvent();

            // 标记容器已初始化
            container.dataset.owoInitialized = 'true';

            this.log('初始化成功');
            return true;
        } catch (error) {
            console.error('[OwoManager] 初始化失败:', error);
            this.destroy();
            return false;
        } finally {
            this.isInitializing = false;
        }
    },

    /**
     * 绑定按钮点击事件
     * 使用 AbortController 管理，避免内存泄漏
     */
    bindButtonEvent() {
        const btn = document.getElementById('owo-button');
        if (!btn || !this.instance || !this.abortController) return;

        // 使用 AbortController 的 signal 自动管理事件监听器
        btn.addEventListener('click', () => {
            if (this.instance && typeof this.instance.toggle === 'function') {
                this.instance.toggle();
            }
        }, { signal: this.abortController.signal });

        this.log('按钮事件已绑定');
    },

    /**
     * 销毁 OwO 实例，释放所有资源
     */
    destroy() {
        this.log('开始销毁实例');

        // 取消所有事件监听器
        if (this.abortController) {
            this.abortController.abort();
            this.abortController = null;
        }

        // 清理 OwO 生成的 DOM
        if (this.container) {
            const body = this.container.querySelector('.OwO-body');
            if (body) {
                body.remove();
            }
            this.container.dataset.owoInitialized = 'false';
        }

        // 清理实例引用
        this.instance = null;
        this.container = null;
        this.target = null;
        this.isInitializing = false;

        this.log('销毁完成');
    },

    /**
     * 检查是否需要重新初始化
     * @returns {boolean}
     */
    needsReinit() {
        const container = document.getElementsByClassName('OwO')[0];
        const target = document.getElementsByClassName('OwO-textarea')[0];

        // 容器或目标不存在
        if (!container || !target) return false;

        // 没有实例
        if (!this.instance) return true;

        // 容器或目标变化
        if (this.container !== container || this.target !== target) return true;

        return false;
    },

    /**
     * 获取当前状态（用于调试）
     */
    getState() {
        return {
            hasInstance: !!this.instance,
            hasContainer: !!this.container,
            hasTarget: !!this.target,
            hasAbortController: !!this.abortController,
            isInitializing: this.isInitializing
        };
    }
};

/**
 * 全局初始化函数（供外部调用）
 * 兼容旧代码，保持 API 不变
 */
function initializeCommentsOwO() {
    OwoManager.init();
}

// ✅ 暴露 OwoManager 到全局作用域，供 Swup 使用
if (typeof window !== 'undefined') {
    window.OwoManager = OwoManager;
    window.initializeCommentsOwO = initializeCommentsOwO;
}

// ✅ 延迟初始化，避免阻塞页面渲染
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeCommentsOwO);
} else {
    // 使用 requestIdleCallback 在浏览器空闲时初始化
    if ('requestIdleCallback' in window) {
        requestIdleCallback(() => initializeCommentsOwO(), { timeout: 2000 });
    } else {
        setTimeout(initializeCommentsOwO, 100);
    }
}

