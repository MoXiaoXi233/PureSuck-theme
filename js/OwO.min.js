/**
 * OWO 表情面板 - SSR 交互版
 *
 * HTML 由 PHP 服务端渲染，此 JS 只负责交互逻辑：
 * - 打开/关闭面板
 * - 分组切换
 * - 表情插入
 * - 指示器动画
 */
(() => {
    'use strict';

    class OwO {
        constructor(option = {}) {
            this.container = option.container || document.querySelector('.OwO');
            this.target = option.target || document.querySelector('.OwO-textarea, textarea');
            this.maxHeight = Math.max(120, parseInt(option.maxHeight, 10) || 260);

            if (!this.container || !this.target) return;

            // 检测是否为 SSR 模式
            this.isSSR = this.container.hasAttribute('data-owo-ssr');

            this._open = false;
            this._scrolling = false;
            this._scrollTimer = 0;
            this._pkgMetrics = null;
            this._pkgMetricsCached = false;

            this._init();
        }

        _init() {
            // 获取 SSR 渲染的元素
            this.logo = this.container.querySelector('.OwO-logo');
            this.body = this.container.querySelector('.OwO-body');
            this.panel = this.container.querySelector('.OwO-panel');
            this.viewport = this.container.querySelector('.OwO-viewport');
            this.indicator = this.container.querySelector('.OwO-indicator');
            this.packagesEle = this.container.querySelector('.OwO-packages');

            if (!this.logo || !this.body || !this.viewport) return;

            // 图片加载状态追踪
            this._imgLoaded = new WeakSet();

            // 绑定 Logo 点击
            this.logo.addEventListener('click', () => this.toggle());

            // 绑定表情点击
            this.body.addEventListener('click', (e) => {
                const item = e.target.closest('.OwO-item');
                if (!item) return;

                const input = item.getAttribute('data-input') || '';
                this._insertText(input);
                this.toggle(false);
            });

            // 绑定分组切换
            if (this.packagesEle) {
                this.packagesEle.addEventListener('click', (e) => {
                    const li = e.target.closest('li[data-idx]');
                    if (!li) return;
                    const idx = parseInt(li.getAttribute('data-idx'), 10);
                    if (Number.isFinite(idx)) this.tab(idx);
                });

                // 分组滚动时更新指示器
                this.packagesEle.addEventListener('scroll', () => {
                    if (!this._open) return;
                    this._scrolling = true;
                    this.container.classList.add('OwO-snap-indicator');
                    this._syncIndicatorFast();

                    clearTimeout(this._scrollTimer);
                    this._scrollTimer = setTimeout(() => {
                        this._scrolling = false;
                        this.container.classList.remove('OwO-snap-indicator');
                        this._syncIndicatorFast();
                    }, 120);
                }, { passive: true });
            }

            // 点击外部关闭
            document.addEventListener('click', (e) => {
                if (!this._open) return;
                if (this.container.contains(e.target)) return;
                this.toggle(false);
            }, true);

            // 窗口 resize 时更新
            window.addEventListener('resize', () => {
                if (this._pkgMetricsCached) {
                    this._cachePkgMetrics();
                }
                if (!this._open) return;
                this.syncHeight();
                this.syncIndicator();
            }, { passive: true });

            // 初始化关闭状态
            this.toggle(false);
        }

        _insertText(text) {
            if (!text || !this.target) return;

            const el = this.target;
            el.focus();
            const start = el.selectionStart ?? (el.value || '').length;
            const end = el.selectionEnd ?? start;

            try {
                el.setRangeText(text, start, end, 'end');
            } catch {
                const v = el.value || '';
                el.value = v.slice(0, start) + text + v.slice(end);
            }
        }

        _cachePkgMetrics() {
            if (!this.packagesEle) return;
            try {
                const lis = Array.from(this.packagesEle.querySelectorAll('li[data-idx]'));
                this._pkgMetrics = lis.map(li => ({
                    w: li.offsetWidth || 0,
                    x: li.offsetLeft || 0
                }));
            } catch {
                this._pkgMetrics = null;
            }
        }

        _syncIndicatorFast() {
            if (!this._pkgMetrics || !this._pkgMetrics.length || !this.indicator) return;

            const active = this.packagesEle.querySelector('.OwO-package-active');
            if (!active) return;

            const idx = parseInt(active.getAttribute('data-idx'), 10);
            if (!Number.isFinite(idx)) return;

            const m = this._pkgMetrics[idx];
            if (!m) return;

            const padding = 20;
            const w = Math.max(18, m.w - padding);
            const x = m.x - (this.packagesEle.scrollLeft || 0);

            this.indicator.style.width = `${w}px`;
            this.indicator.style.transform = `translateX(${x}px)`;
        }

        toggle(force) {
            const next = typeof force === 'boolean' ? force : !this._open;
            this._open = next;
            this.container.classList.toggle('OwO-open', next);

            if (next) {
                // 首次打开时缓存几何属性
                if (!this._pkgMetricsCached) {
                    this._pkgMetricsCached = true;
                    // 延迟确保 DOM 完全渲染
                    setTimeout(() => {
                        this._cachePkgMetrics();
                        this.syncIndicator();
                        this.syncHeight();
                    }, 20);
                } else {
                    this.syncIndicator();
                    this.syncHeight();
                }
            } else if (this.viewport) {
                this.viewport.style.maxHeight = '0px';
            }
        }

        tab(index) {
            // 隐藏当前分组
            const cur = this.container.querySelector('.OwO-items:not([hidden])');
            if (cur) cur.setAttribute('hidden', '');

            // 显示目标分组
            const next = this.container.querySelector(`ul[data-pkg-idx="${index}"]`);
            if (next) next.removeAttribute('hidden');

            // 更新激活状态
            const act = this.packagesEle?.querySelector('.OwO-package-active');
            if (act) act.classList.remove('OwO-package-active');

            const li = this.packagesEle?.querySelector(`li[data-idx="${index}"]`);
            if (li) li.classList.add('OwO-package-active');

            this._syncIndicatorFast();

            // 延迟计算高度，确保 DOM 完全渲染
            if (this._open) {
                // 用 setTimeout 比 RAF 更可靠
                setTimeout(() => this.syncHeight(), 20);
            }
        }

        syncHeight() {
            const list = this.container.querySelector('.OwO-items:not([hidden])');
            if (!list || !this.viewport) return;

            // 临时移除限制以获取真实 scrollHeight
            list.style.maxHeight = 'none';
            list.style.overflow = 'visible';

            const sh = list.scrollHeight;
            const targetH = Math.min(sh, this.maxHeight);

            // 应用最终样式
            list.style.maxHeight = `${this.maxHeight}px`;
            list.style.overflow = sh > this.maxHeight ? 'auto' : 'hidden';
            this.viewport.style.maxHeight = `${targetH}px`;

            // 监听当前列表的图片加载
            this._bindImgLoad(list);
        }

        _bindImgLoad(list) {
            if (!list) return;
            const imgs = list.querySelectorAll('img');
            imgs.forEach(img => {
                if (this._imgLoaded.has(img)) return;
                if (img.complete) {
                    this._imgLoaded.add(img);
                    return;
                }
                this._imgLoaded.add(img);
                const onLoad = () => {
                    if (this._open) this.syncHeight();
                };
                img.addEventListener('load', onLoad, { once: true });
                img.addEventListener('error', onLoad, { once: true });
            });
        }

        syncIndicator() {
            if (!this.packagesEle || !this.indicator) return;

            const li = this.packagesEle.querySelector('.OwO-package-active');
            if (!li) return;

            const idx = parseInt(li.getAttribute('data-idx'), 10);

            if (Number.isFinite(idx) && this._pkgMetrics && this._pkgMetrics[idx]) {
                const m = this._pkgMetrics[idx];
                const padding = 20;
                const w = Math.max(18, m.w - padding);
                const x = m.x - (this.packagesEle.scrollLeft || 0);

                this.indicator.style.width = `${w}px`;
                this.indicator.style.transform = `translateX(${x}px)`;
                return;
            }

            // 降级：直接读取位置
            const wrapRect = this.packagesEle.getBoundingClientRect();
            const liRect = li.getBoundingClientRect();
            const w = Math.max(18, liRect.width);
            const x = liRect.left - wrapRect.left;

            this.indicator.style.width = `${w}px`;
            this.indicator.style.transform = `translateX(${x}px)`;
        }
    }

    // 暴露到全局
    window.OwO = OwO;

    /**
     * OWO 管理器 - 与 Swup 集成
     */
    const OwoManager = {
        instance: null,
        container: null,
        target: null,
        abortController: null,

        init(options = {}) {
            const { force = false } = options;

            const container = document.querySelector('.OwO[data-owo-ssr]');
            const target = document.querySelector('.OwO-textarea, #textarea');

            if (!container || !target) {
                this.destroy();
                return false;
            }

            // 复用现有实例
            if (!force && this.instance && this.container === container && this.target === target) {
                return true;
            }

            // 容器变化，销毁旧实例
            if (this.instance && (this.container !== container || this.target !== target)) {
                this.destroy();
            }

            try {
                this.abortController = new AbortController();
                this.container = container;
                this.target = target;

                this.instance = new OwO({
                    container,
                    target,
                    maxHeight: 260
                });

                container.dataset.owoInitialized = 'true';
                return true;
            } catch (error) {
                console.error('[OwoManager] init failed:', error);
                this.destroy();
                return false;
            }
        },

        destroy() {
            if (this.abortController) {
                this.abortController.abort();
                this.abortController = null;
            }

            if (this.container) {
                this.container.dataset.owoInitialized = 'false';
            }

            this.instance = null;
            this.container = null;
            this.target = null;
        }
    };

    window.OwoManager = OwoManager;
    window.initializeCommentsOwO = () => OwoManager.init();

    // 自动初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => OwoManager.init());
    } else {
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => OwoManager.init(), { timeout: 2000 });
        } else {
            setTimeout(() => OwoManager.init(), 100);
        }
    }
})();
